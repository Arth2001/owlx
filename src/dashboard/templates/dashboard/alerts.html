{% extends "dashboard/base.html" %}

{% block title %}Alerts - OwlX Agent Monitoring Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Alerts</h1>
        <div>
            <button id="btn-create-alert" class="btn btn-primary me-2">
                <i class="fas fa-plus"></i> Create Alert
            </button>
            <button id="btn-refresh" class="btn btn-outline-secondary me-2">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button id="btn-edit-selected" class="btn btn-info me-2" disabled>
                <i class="fas fa-edit"></i> Edit Selected
            </button>
            <button id="btn-acknowledge-selected" class="btn btn-warning me-2" disabled>
                <i class="fas fa-check"></i> Acknowledge Selected
            </button>
            <button id="btn-resolve-selected" class="btn btn-success" disabled>
                <i class="fas fa-check-double"></i> Resolve Selected
            </button>
        </div>
    </div>
    
    <!-- Alert Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">New Alerts</h5>
                    <h2 class="card-text" id="new-alerts-count">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Acknowledged</h5>
                    <h2 class="card-text" id="acknowledged-alerts-count">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Resolved</h5>
                    <h2 class="card-text" id="resolved-alerts-count">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Alerts</h5>
                    <h2 class="card-text" id="total-alerts-count">-</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            Filters
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filter-status">Status</label>
                        <select id="filter-status" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="new">New</option>
                            <option value="acknowledged">Acknowledged</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filter-severity">Severity</label>
                        <select id="filter-severity" class="form-select">
                            <option value="">All Severities</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filter-agent">Agent</label>
                        <select id="filter-agent" class="form-select">
                            <option value="">All Agents</option>
                            <!-- Will be populated via JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filter-rule">Rule</label>
                        <select id="filter-rule" class="form-select">
                            <option value="">All Rules</option>
                            <!-- Will be populated via JavaScript -->
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alerts Table -->
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <span>Alerts</span>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all-alerts">
                    <label class="form-check-label text-white" for="select-all-alerts">
                        Select All
                    </label>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>Agent</th>
                            <th>Rule</th>
                            <th>Severity</th>
                            <th>Value</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-table-body">
                        <tr>
                            <td colspan="8" class="text-center">Loading alerts...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <nav>
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Will be populated via JavaScript -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Alert Edit Modal -->
<div class="modal fade" id="editAlertModal" tabindex="-1" aria-labelledby="editAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAlertModalLabel">Edit Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAlertForm">
                    <input type="hidden" id="edit-alert-id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-alert-agent" class="form-label">Agent</label>
                            <input type="text" class="form-control" id="edit-alert-agent" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-alert-rule" class="form-label">Rule</label>
                            <input type="text" class="form-control" id="edit-alert-rule" readonly>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-alert-severity" class="form-label">Severity</label>
                            <select class="form-select" id="edit-alert-severity">
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-alert-status" class="form-label">Status</label>
                            <select class="form-select" id="edit-alert-status">
                                <option value="new">New</option>
                                <option value="acknowledged">Acknowledged</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-alert-message" class="form-label">Message</label>
                        <textarea class="form-control" id="edit-alert-message" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-alert-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="edit-alert-notes" rows="3" placeholder="Add any additional notes or comments"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-alert-changes">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Alert Modal -->
<div class="modal fade" id="createAlertModal" tabindex="-1" aria-labelledby="createAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createAlertModalLabel">Create New Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createAlertForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="create-alert-agent" class="form-label">Agent</label>
                            <select class="form-select" id="create-alert-agent" required>
                                <option value="">Select Agent</option>
                                <!-- Will be populated via JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="create-alert-rule" class="form-label">Rule</label>
                            <select class="form-select" id="create-alert-rule" required>
                                <option value="">Select Rule</option>
                                <!-- Will be populated via JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="create-alert-value" class="form-label">Value</label>
                            <input type="number" class="form-control" id="create-alert-value" required step="0.01">
                        </div>
                        <div class="col-md-6">
                            <label for="create-alert-status" class="form-label">Status</label>
                            <select class="form-select" id="create-alert-status" required>
                                <option value="new">New</option>
                                <option value="acknowledged">Acknowledged</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="create-alert-message" class="form-label">Message</label>
                        <textarea class="form-control" id="create-alert-message" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="create-alert-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="create-alert-notes" rows="3" placeholder="Add any additional notes or comments"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-new-alert">Create Alert</button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Edit Modal -->
<div class="modal fade" id="batchEditModal" tabindex="-1" aria-labelledby="batchEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchEditModalLabel">Edit Selected Alerts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Editing <span id="selected-count">0</span> alerts</strong></p>
                
                <form id="batchEditForm">
                    <div class="mb-3">
                        <label for="batch-edit-status" class="form-label">Status</label>
                        <select class="form-select" id="batch-edit-status">
                            <option value="">No change</option>
                            <option value="new">New</option>
                            <option value="acknowledged">Acknowledged</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="batch-edit-notes" class="form-label">Add Notes</label>
                        <textarea class="form-control" id="batch-edit-notes" rows="3" placeholder="Add notes to all selected alerts"></textarea>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="batch-append-notes">
                        <label class="form-check-label" for="batch-append-notes">
                            Append to existing notes instead of replacing
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-batch-changes">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    // Alert data and state
    let alerts = [];
    let currentPage = 1;
    let itemsPerPage = 10;
    let totalPages = 0;
    let selectedAlerts = new Set();
    
    // Check if we should auto-open modals from server context
    {% if show_create_modal %}
    document.addEventListener('DOMContentLoaded', function() {
        openCreateAlertModal();
    });
    {% endif %}
    
    {% if show_edit_modal and edit_alert %}
    document.addEventListener('DOMContentLoaded', function() {
        const alert = {
            id: "{{ edit_alert.id }}",
            agent_detail: { name: "{{ edit_alert.agent.name }}" },
            rule_detail: { 
                name: "{{ edit_alert.rule.name }}",
                severity: "{{ edit_alert.rule.severity }}"
            },
            status: "{{ edit_alert.status }}",
            message: "{{ edit_alert.message|escapejs }}",
            notes: "{% if edit_alert.notes %}{{ edit_alert.notes|escapejs }}{% else %}{% endif %}"
        };
        setTimeout(function() { openEditModal(alert); }, 500);
    });
    {% endif %}
    
    // Filter state
    let filters = {
        status: '',
        severity: '',
        agent: '',
        rule: ''
    };
    
    // Available agents and rules for filters
    let agents = [];
    let rules = [];
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners
        document.getElementById('btn-refresh').addEventListener('click', loadAlerts);
        document.getElementById('btn-acknowledge-selected').addEventListener('click', acknowledgeSelected);
        document.getElementById('btn-resolve-selected').addEventListener('click', resolveSelected);
        document.getElementById('btn-edit-selected').addEventListener('click', openBatchEditModal);
        document.getElementById('select-all-alerts').addEventListener('change', toggleSelectAll);
        
        // Create alert button
        document.getElementById('btn-create-alert').addEventListener('click', openCreateAlertModal);
        document.getElementById('save-new-alert').addEventListener('click', createNewAlert);
        
        // Edit modal save buttons
        document.getElementById('save-alert-changes').addEventListener('click', saveAlertChanges);
        document.getElementById('save-batch-changes').addEventListener('click', saveBatchChanges);
        
        // Check URL for query parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('create')) {
            openCreateAlertModal();
        }
        if (urlParams.has('edit')) {
            const alertId = urlParams.get('edit');
            fetchAndOpenEditModal(alertId);
        }
        
        // Rule selection event for autofilling severity
        document.getElementById('create-alert-rule').addEventListener('change', function() {
            const ruleId = this.value;
            if (ruleId) {
                const rule = rules.find(r => r.id.toString() === ruleId);
                if (rule) {
                    // Autofill message based on rule
                    const value = document.getElementById('create-alert-value').value || '0';
                    const message = `Metric ${rule.metric_name} with value ${value} triggered rule '${rule.name}'`;
                    document.getElementById('create-alert-message').value = message;
                }
            }
        });
        
        // Value change for updating message
        document.getElementById('create-alert-value').addEventListener('input', function() {
            const ruleId = document.getElementById('create-alert-rule').value;
            if (ruleId) {
                const rule = rules.find(r => r.id.toString() === ruleId);
                if (rule) {
                    const value = this.value || '0';
                    const message = `Metric ${rule.metric_name} with value ${value} triggered rule '${rule.name}'`;
                    document.getElementById('create-alert-message').value = message;
                }
            }
        });
        
        // Set up filter change listeners
        document.getElementById('filter-status').addEventListener('change', function() {
            filters.status = this.value;
            loadAlerts();
        });
        
        document.getElementById('filter-severity').addEventListener('change', function() {
            filters.severity = this.value;
            loadAlerts();
        });
        
        document.getElementById('filter-agent').addEventListener('change', function() {
            filters.agent = this.value;
            loadAlerts();
        });
        
        document.getElementById('filter-rule').addEventListener('change', function() {
            filters.rule = this.value;
            loadAlerts();
        });
        
        // Load initial data
        loadAlertSummary();
        loadAgents();
        loadRules();
        loadAlerts();
        
        // Set interval to refresh data
        setInterval(loadAlertSummary, 30000); // Refresh summary every 30 seconds
    });
    
    // Load alert summary data
    function loadAlertSummary() {
        fetch('/api/alerts/summary/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('new-alerts-count').textContent = data.by_status.new;
                document.getElementById('acknowledged-alerts-count').textContent = data.by_status.acknowledged;
                document.getElementById('resolved-alerts-count').textContent = data.by_status.resolved;
                document.getElementById('total-alerts-count').textContent = data.total;
            })
            .catch(error => {
                console.error('Error loading alert summary:', error);
            });
    }
    
    // Load agents for filter
    function loadAgents() {
        fetch('/api/agents/')
            .then(response => response.json())
            .then(data => {
                agents = data;
                const agentSelect = document.getElementById('filter-agent');
                
                // Clear existing options except the first one
                while (agentSelect.options.length > 1) {
                    agentSelect.remove(1);
                }
                
                // Add new options
                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = agent.name;
                    agentSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading agents:', error);
            });
    }
    
    // Load rules for filter
    function loadRules() {
        fetch('/api/rules/')
            .then(response => response.json())
            .then(data => {
                rules = data;
                const ruleSelect = document.getElementById('filter-rule');
                
                // Clear existing options except the first one
                while (ruleSelect.options.length > 1) {
                    ruleSelect.remove(1);
                }
                
                // Add new options
                rules.forEach(rule => {
                    const option = document.createElement('option');
                    option.value = rule.id;
                    option.textContent = rule.name;
                    option.dataset.severity = rule.severity;
                    ruleSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading rules:', error);
            });
    }
    
    // Load alerts with current filters
    function loadAlerts() {
        // Build query parameters
        const params = new URLSearchParams();
        if (filters.status) params.append('status', filters.status);
        if (filters.severity) params.append('severity', filters.severity);
        if (filters.agent) params.append('agent_id', filters.agent);
        if (filters.rule) params.append('rule_id', filters.rule);
        
        // Clear selected alerts
        selectedAlerts.clear();
        updateActionButtons();
        
        fetch(`/api/alerts/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                alerts = data;
                totalPages = Math.ceil(alerts.length / itemsPerPage);
                renderAlerts();
                renderPagination();
            })
            .catch(error => {
                console.error('Error loading alerts:', error);
            });
    }
    
    // Render alerts table
    function renderAlerts() {
        const tableBody = document.getElementById('alerts-table-body');
        tableBody.innerHTML = '';
        
        // Calculate current page slice
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentAlerts = alerts.slice(startIndex, endIndex);
        
        if (currentAlerts.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="8" class="text-center">No alerts found</td>';
            tableBody.appendChild(emptyRow);
            return;
        }
        
        currentAlerts.forEach(alert => {
            const row = document.createElement('tr');
            
            // Checkbox
            const checkboxCell = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input alert-checkbox';
            checkbox.dataset.alertId = alert.id;
            checkbox.checked = selectedAlerts.has(alert.id.toString());
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedAlerts.add(alert.id.toString());
                } else {
                    selectedAlerts.delete(alert.id.toString());
                }
                updateActionButtons();
            });
            
            // Only allow selecting alerts that aren't resolved
            if (alert.status === 'resolved') {
                checkbox.disabled = true;
            }
            
            checkboxCell.appendChild(checkbox);
            row.appendChild(checkboxCell);
            
            // Agent
            const agentCell = document.createElement('td');
            agentCell.textContent = alert.agent_detail.name;
            row.appendChild(agentCell);
            
            // Rule
            const ruleCell = document.createElement('td');
            ruleCell.textContent = alert.rule_detail.name;
            row.appendChild(ruleCell);
            
            // Severity
            const severityCell = document.createElement('td');
            let severityBadge = '';
            if (alert.rule_detail.severity === 'critical') {
                severityBadge = '<span class="badge bg-danger">Critical</span>';
            } else if (alert.rule_detail.severity === 'high') {
                severityBadge = '<span class="badge bg-warning text-dark">High</span>';
            } else if (alert.rule_detail.severity === 'medium') {
                severityBadge = '<span class="badge bg-info text-dark">Medium</span>';
            } else {
                severityBadge = '<span class="badge bg-secondary">Low</span>';
            }
            severityCell.innerHTML = severityBadge;
            row.appendChild(severityCell);
            
            // Value
            const valueCell = document.createElement('td');
            valueCell.textContent = alert.value;
            row.appendChild(valueCell);
            
            // Status
            const statusCell = document.createElement('td');
            let statusBadge = '';
            if (alert.status === 'new') {
                statusBadge = '<span class="badge bg-danger">New</span>';
            } else if (alert.status === 'acknowledged') {
                statusBadge = '<span class="badge bg-warning text-dark">Acknowledged</span>';
            } else {
                statusBadge = '<span class="badge bg-success">Resolved</span>';
            }
            statusCell.innerHTML = statusBadge;
            row.appendChild(statusCell);
            
            // Created At
            const createdAtCell = document.createElement('td');
            const createdDate = new Date(alert.created_at);
            createdAtCell.textContent = createdDate.toLocaleString();
            row.appendChild(createdAtCell);
            
            // Actions
            const actionsCell = document.createElement('td');
            
            // Edit button (available for all alerts)
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-sm btn-info me-1';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.title = 'Edit Alert';
            editBtn.addEventListener('click', () => openEditModal(alert));
            actionsCell.appendChild(editBtn);
            
            if (alert.status === 'new') {
                const acknowledgeBtn = document.createElement('button');
                acknowledgeBtn.className = 'btn btn-sm btn-warning me-1';
                acknowledgeBtn.innerHTML = '<i class="fas fa-check"></i>';
                acknowledgeBtn.title = 'Acknowledge';
                acknowledgeBtn.addEventListener('click', () => acknowledgeAlert(alert.id));
                actionsCell.appendChild(acknowledgeBtn);
                
                const resolveBtn = document.createElement('button');
                resolveBtn.className = 'btn btn-sm btn-success';
                resolveBtn.innerHTML = '<i class="fas fa-check-double"></i>';
                resolveBtn.title = 'Resolve';
                resolveBtn.addEventListener('click', () => resolveAlert(alert.id));
                actionsCell.appendChild(resolveBtn);
            } else if (alert.status === 'acknowledged') {
                const resolveBtn = document.createElement('button');
                resolveBtn.className = 'btn btn-sm btn-success';
                resolveBtn.innerHTML = '<i class="fas fa-check-double"></i>';
                resolveBtn.title = 'Resolve';
                resolveBtn.addEventListener('click', () => resolveAlert(alert.id));
                actionsCell.appendChild(resolveBtn);
            }
            
            row.appendChild(actionsCell);
            
            tableBody.appendChild(row);
        });
    }
    
    // Render pagination controls
    function renderPagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        if (totalPages <= 1) {
            return;
        }
        
        // Previous button
        const prevItem = document.createElement('li');
        prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        const prevLink = document.createElement('a');
        prevLink.className = 'page-link';
        prevLink.href = '#';
        prevLink.textContent = 'Previous';
        prevLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                renderAlerts();
                renderPagination();
            }
        });
        prevItem.appendChild(prevLink);
        pagination.appendChild(prevItem);
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
            const pageLink = document.createElement('a');
            pageLink.className = 'page-link';
            pageLink.href = '#';
            pageLink.textContent = i;
            pageLink.addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = i;
                renderAlerts();
                renderPagination();
            });
            pageItem.appendChild(pageLink);
            pagination.appendChild(pageItem);
        }
        
        // Next button
        const nextItem = document.createElement('li');
        nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        const nextLink = document.createElement('a');
        nextLink.className = 'page-link';
        nextLink.href = '#';
        nextLink.textContent = 'Next';
        nextLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage < totalPages) {
                currentPage++;
                renderAlerts();
                renderPagination();
            }
        });
        nextItem.appendChild(nextLink);
        pagination.appendChild(nextItem);
    }
    
    // Toggle select all alerts
    function toggleSelectAll() {
        const checkAll = document.getElementById('select-all-alerts').checked;
        const checkboxes = document.querySelectorAll('.alert-checkbox:not(:disabled)');
        
        selectedAlerts.clear();
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = checkAll;
            if (checkAll) {
                selectedAlerts.add(checkbox.dataset.alertId);
            }
        });
        
        updateActionButtons();
    }
    
    // Update action buttons enabled state
    function updateActionButtons() {
        const hasSelection = selectedAlerts.size > 0;
        document.getElementById('btn-acknowledge-selected').disabled = !hasSelection;
        document.getElementById('btn-resolve-selected').disabled = !hasSelection;
        document.getElementById('btn-edit-selected').disabled = !hasSelection;
    }
    
    // Acknowledge a single alert
    function acknowledgeAlert(alertId) {
        fetch(`/api/alerts/${alertId}/acknowledge/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
            .then(response => {
                if (response.ok) {
                    loadAlerts();
                    loadAlertSummary();
                } else {
                    console.error('Error acknowledging alert');
                }
            })
            .catch(error => {
                console.error('Error acknowledging alert:', error);
            });
    }
    
    // Resolve a single alert
    function resolveAlert(alertId) {
        fetch(`/api/alerts/${alertId}/resolve/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
            .then(response => {
                if (response.ok) {
                    loadAlerts();
                    loadAlertSummary();
                } else {
                    console.error('Error resolving alert');
                }
            })
            .catch(error => {
                console.error('Error resolving alert:', error);
            });
    }
    
    // Acknowledge selected alerts
    function acknowledgeSelected() {
        if (selectedAlerts.size === 0) return;
        
        fetch('/api/alerts/bulk_acknowledge/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                alert_ids: Array.from(selectedAlerts)
            })
        })
            .then(response => {
                if (response.ok) {
                    loadAlerts();
                    loadAlertSummary();
                } else {
                    console.error('Error acknowledging alerts');
                }
            })
            .catch(error => {
                console.error('Error acknowledging alerts:', error);
            });
    }
    
    // Resolve selected alerts
    function resolveSelected() {
        if (selectedAlerts.size === 0) return;
        
        fetch('/api/alerts/bulk_resolve/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                alert_ids: Array.from(selectedAlerts)
            })
        })
            .then(response => {
                if (response.ok) {
                    loadAlerts();
                    loadAlertSummary();
                } else {
                    console.error('Error resolving alerts');
                }
            })
            .catch(error => {
                console.error('Error resolving alerts:', error);
            });
    }
    
    // Get CSRF token from cookies
    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Open edit modal with alert data
    function openEditModal(alert) {
        // Populate form with alert data
        document.getElementById('edit-alert-id').value = alert.id;
        document.getElementById('edit-alert-agent').value = alert.agent_detail.name;
        document.getElementById('edit-alert-rule').value = alert.rule_detail.name;
        document.getElementById('edit-alert-severity').value = alert.rule_detail.severity;
        document.getElementById('edit-alert-status').value = alert.status;
        document.getElementById('edit-alert-message').value = alert.message;
        
        // Set notes if available
        if (alert.notes) {
            document.getElementById('edit-alert-notes').value = alert.notes;
        } else {
            document.getElementById('edit-alert-notes').value = '';
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editAlertModal'));
        modal.show();
    }
    
    // Save alert changes
    function saveAlertChanges() {
        const alertId = document.getElementById('edit-alert-id').value;
        const status = document.getElementById('edit-alert-status').value;
        const notes = document.getElementById('edit-alert-notes').value;
        const message = document.getElementById('edit-alert-message').value;
        
        // Prepare update data
        const updateData = {
            status: status,
            message: message,
            notes: notes
        };
        
        // Send update request
        fetch(`/api/alerts/${alertId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(updateData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('editAlertModal')).hide();
            
            // Refresh alerts
            loadAlerts();
            
            // Show success message
            alert('Alert updated successfully');
        })
        .catch(error => {
            console.error('Error updating alert:', error);
            alert('Error updating alert: ' + error.message);
        });
    }
    
    // Open create alert modal
    function openCreateAlertModal() {
        // Clear the form
        document.getElementById('createAlertForm').reset();
        
        // Populate agent dropdown
        const agentSelect = document.getElementById('create-alert-agent');
        
        // Clear existing options except the first one
        while (agentSelect.options.length > 1) {
            agentSelect.remove(1);
        }
        
        // Add agent options
        agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.id;
            option.textContent = agent.name;
            agentSelect.appendChild(option);
        });
        
        // Populate rule dropdown
        const ruleSelect = document.getElementById('create-alert-rule');
        
        // Clear existing options except the first one
        while (ruleSelect.options.length > 1) {
            ruleSelect.remove(1);
        }
        
        // Add rule options
        rules.forEach(rule => {
            const option = document.createElement('option');
            option.value = rule.id;
            option.textContent = rule.name;
            option.dataset.severity = rule.severity;
            ruleSelect.appendChild(option);
        });
        
        // Set default status to 'new'
        document.getElementById('create-alert-status').value = 'new';
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('createAlertModal'));
        modal.show();
    }
    
    // Create a new alert
    function createNewAlert() {
        // Validate form
        const agentId = document.getElementById('create-alert-agent').value;
        const ruleId = document.getElementById('create-alert-rule').value;
        const value = document.getElementById('create-alert-value').value;
        const status = document.getElementById('create-alert-status').value;
        const message = document.getElementById('create-alert-message').value;
        const notes = document.getElementById('create-alert-notes').value;
        
        if (!agentId || !ruleId || !value || !status || !message) {
            alert('Please fill in all required fields');
            return;
        }
        
        // Prepare alert data
        const alertData = {
            agent: agentId,
            rule: ruleId,
            value: parseFloat(value),
            status: status,
            message: message,
            notes: notes
        };
        
        // Send create request
        fetch('/api/alerts/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(alertData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('createAlertModal')).hide();
            
            // Refresh alerts
            loadAlerts();
            loadAlertSummary();
            
            // Show success message
            alert('Alert created successfully');
        })
        .catch(error => {
            console.error('Error creating alert:', error);
            alert('Error creating alert: ' + error.message);
        });
    }

    // Open batch edit modal for selected alerts
    function openBatchEditModal() {
        // Check if any alerts are selected
        if (selectedAlerts.size === 0) {
            alert('No alerts selected');
            return;
        }

        // Reset form
        document.getElementById('batchEditForm').reset();
        document.getElementById('selected-count').textContent = selectedAlerts.size;
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('batchEditModal'));
        modal.show();
    }
    
    // Save batch edit changes
    function saveBatchChanges() {
        // Get the form values
        const status = document.getElementById('batch-edit-status').value;
        const notes = document.getElementById('batch-edit-notes').value;
        const appendNotes = document.getElementById('batch-append-notes').checked;
        
        // Check if any changes were made
        if (!status && !notes) {
            alert('No changes to apply');
            return;
        }
        
        // Get the selected alert IDs
        const alertIds = Array.from(selectedAlerts);
        
        // Process each alert
        let completedCount = 0;
        let errorCount = 0;
        
        alertIds.forEach(alertId => {
            // First, we need to get the current alert data if appending notes
            if (appendNotes && notes) {
                fetch(`/api/alerts/${alertId}/`)
                    .then(response => response.json())
                    .then(alert => {
                        updateSingleAlert(alertId, status, 
                            appendNotes ? (alert.notes ? alert.notes + '\n\n' + notes : notes) : notes);
                    })
                    .catch(error => {
                        console.error(`Error fetching alert ${alertId}:`, error);
                        errorCount++;
                    });
            } else {
                // Direct update without fetching first
                updateSingleAlert(alertId, status, notes);
            }
        });
        
        function updateSingleAlert(alertId, status, notes) {
            // Prepare update data
            const updateData = {};
            
            if (status) updateData.status = status;
            if (notes !== undefined) updateData.notes = notes;
            
            // If setting status to resolved, add resolved_at timestamp
            if (status === 'resolved') {
                updateData.resolved_at = new Date().toISOString();
            }
            
            // Send the update request
            fetch(`/api/alerts/${alertId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(updateData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                completedCount++;
                
                // Check if all updates are complete
                if (completedCount + errorCount === alertIds.length) {
                    finishBatchUpdate(completedCount, errorCount);
                }
            })
            .catch(error => {
                console.error(`Error updating alert ${alertId}:`, error);
                errorCount++;
                
                // Check if all updates are complete
                if (completedCount + errorCount === alertIds.length) {
                    finishBatchUpdate(completedCount, errorCount);
                }
            });
        }
        
        function finishBatchUpdate(succeeded, failed) {
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('batchEditModal')).hide();
            
            // Refresh the alerts
            loadAlerts();
            loadAlertSummary();
            
            // Show success/error message
            if (failed === 0) {
                alert(`Successfully updated ${succeeded} alerts`);
            } else {
                alert(`Updated ${succeeded} alerts with ${failed} errors`);
            }
        }
    }

    // Function to fetch alert data and open edit modal
    function fetchAndOpenEditModal(alertId) {
        fetch(`/api/alerts/${alertId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(alert => {
                openEditModal(alert);
                
                // Remove the edit parameter from URL
                const url = new URL(window.location);
                url.searchParams.delete('edit');
                window.history.replaceState({}, '', url);
            })
            .catch(error => {
                console.error('Error fetching alert:', error);
                alert('Error fetching alert: ' + error.message);
            });
    }
</script>
{% endblock %} 