{% extends "dashboard/base.html" %}

{% block title %}Monitoring Rules - OwlX Agent Monitoring Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Monitoring Rules</h1>
        <div>
            <button id="btn-refresh" class="btn btn-outline-secondary me-2">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button id="btn-add-rule" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ruleModal">
                <i class="fas fa-plus"></i> Add Rule
            </button>
        </div>
    </div>
    
    <!-- Rules Table -->
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <span>Monitoring Rules</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Metric</th>
                            <th>Condition</th>
                            <th>Threshold</th>
                            <th>Severity</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rules-table-body">
                        <tr>
                            <td colspan="7" class="text-center">Loading rules...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Rule Modal -->
<div class="modal fade" id="ruleModal" tabindex="-1" aria-labelledby="ruleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ruleModalLabel">Add Monitoring Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="rule-form">
                    <input type="hidden" id="rule-id" value="">
                    
                    <div class="mb-3">
                        <label for="rule-name" class="form-label">Rule Name</label>
                        <input type="text" class="form-control" id="rule-name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="rule-description" class="form-label">Description</label>
                        <textarea class="form-control" id="rule-description" rows="2"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="rule-metric" class="form-label">Metric Name</label>
                            <select class="form-select" id="rule-metric" required>
                                <option value="">Select a metric</option>
                                <option value="cpu_usage">CPU Usage</option>
                                <option value="memory_usage">Memory Usage</option>
                                <option value="disk_usage">Disk Usage</option>
                                <option value="network_in">Network In</option>
                                <option value="network_out">Network Out</option>
                                <option value="custom">Custom...</option>
                            </select>
                        </div>
                        <div class="col-md-4" id="custom-metric-container" style="display: none;">
                            <label for="rule-custom-metric" class="form-label">Custom Metric Name</label>
                            <input type="text" class="form-control" id="rule-custom-metric">
                        </div>
                        <div class="col-md-4">
                            <label for="rule-condition" class="form-label">Condition</label>
                            <select class="form-select" id="rule-condition" required>
                                <option value="">Select condition</option>
                                <option value="gt">Greater than</option>
                                <option value="lt">Less than</option>
                                <option value="eq">Equal to</option>
                                <option value="ne">Not equal to</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="rule-threshold" class="form-label">Threshold</label>
                            <input type="number" class="form-control" id="rule-threshold" required step="0.01">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="rule-severity" class="form-label">Severity</label>
                            <select class="form-select" id="rule-severity" required>
                                <option value="">Select severity</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label d-block">Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="rule-enabled" checked>
                                <label class="form-check-label" for="rule-enabled">Enabled</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="btn-delete-rule" style="display: none;">Delete</button>
                <button type="button" class="btn btn-primary" id="btn-save-rule">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this monitoring rule? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="btn-confirm-delete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    // Store the current rule being edited for deletion reference
    let currentRuleId = null;
    
    // Modal and form handling
    const ruleModal = document.getElementById('ruleModal');
    const ruleForm = document.getElementById('rule-form');
    const ruleIdInput = document.getElementById('rule-id');
    const ruleNameInput = document.getElementById('rule-name');
    const ruleDescriptionInput = document.getElementById('rule-description');
    const ruleMetricSelect = document.getElementById('rule-metric');
    const ruleCustomMetricInput = document.getElementById('rule-custom-metric');
    const ruleCustomMetricContainer = document.getElementById('custom-metric-container');
    const ruleConditionSelect = document.getElementById('rule-condition');
    const ruleThresholdInput = document.getElementById('rule-threshold');
    const ruleSeveritySelect = document.getElementById('rule-severity');
    const ruleEnabledSwitch = document.getElementById('rule-enabled');
    const btnSaveRule = document.getElementById('btn-save-rule');
    const btnDeleteRule = document.getElementById('btn-delete-rule');
    const btnConfirmDelete = document.getElementById('btn-confirm-delete');
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners
        document.getElementById('btn-refresh').addEventListener('click', loadRules);
        
        // Custom metric handling
        ruleMetricSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                ruleCustomMetricContainer.style.display = 'block';
                ruleCustomMetricInput.required = true;
            } else {
                ruleCustomMetricContainer.style.display = 'none';
                ruleCustomMetricInput.required = false;
            }
        });
        
        // Modal event listeners
        ruleModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            // Check if we're editing or adding
            if (button && button.hasAttribute('data-rule-id')) {
                // Editing existing rule
                const ruleId = button.getAttribute('data-rule-id');
                loadRuleDetails(ruleId);
                currentRuleId = ruleId;
                
                // Update modal title and show delete button
                document.getElementById('ruleModalLabel').textContent = 'Edit Monitoring Rule';
                btnDeleteRule.style.display = 'block';
            } else {
                // Adding new rule
                resetRuleForm();
                currentRuleId = null;
                
                // Update modal title and hide delete button
                document.getElementById('ruleModalLabel').textContent = 'Add Monitoring Rule';
                btnDeleteRule.style.display = 'none';
            }
        });
        
        // Save rule button
        btnSaveRule.addEventListener('click', saveRule);
        
        // Delete button shows confirmation modal
        btnDeleteRule.addEventListener('click', function() {
            const bsModal = bootstrap.Modal.getInstance(ruleModal);
            bsModal.hide();
            
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            confirmModal.show();
        });
        
        // Confirm delete button
        btnConfirmDelete.addEventListener('click', function() {
            if (currentRuleId) {
                deleteRule(currentRuleId);
            }
            
            const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
            confirmModal.hide();
        });
        
        // Load initial data
        loadRules();
    });
    
    // Load all rules
    function loadRules() {
        fetch('/api/rules/')
            .then(response => response.json())
            .then(data => {
                renderRules(data);
            })
            .catch(error => {
                console.error('Error loading rules:', error);
            });
    }
    
    // Load details for a specific rule
    function loadRuleDetails(ruleId) {
        fetch(`/api/rules/${ruleId}/`)
            .then(response => response.json())
            .then(rule => {
                // Populate form
                ruleIdInput.value = rule.id;
                ruleNameInput.value = rule.name;
                ruleDescriptionInput.value = rule.description || '';
                
                // Handle custom vs standard metrics
                const standardMetrics = ['cpu_usage', 'memory_usage', 'disk_usage', 'network_in', 'network_out'];
                if (standardMetrics.includes(rule.metric_name)) {
                    ruleMetricSelect.value = rule.metric_name;
                    ruleCustomMetricContainer.style.display = 'none';
                } else {
                    ruleMetricSelect.value = 'custom';
                    ruleCustomMetricInput.value = rule.metric_name;
                    ruleCustomMetricContainer.style.display = 'block';
                }
                
                ruleConditionSelect.value = rule.condition;
                ruleThresholdInput.value = rule.threshold;
                ruleSeveritySelect.value = rule.severity;
                ruleEnabledSwitch.checked = rule.enabled;
            })
            .catch(error => {
                console.error('Error loading rule details:', error);
            });
    }
    
    // Render rules table
    function renderRules(rules) {
        const tableBody = document.getElementById('rules-table-body');
        tableBody.innerHTML = '';
        
        if (rules.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="7" class="text-center">No monitoring rules found</td>';
            tableBody.appendChild(emptyRow);
            return;
        }
        
        rules.forEach(rule => {
            const row = document.createElement('tr');
            
            // Name
            const nameCell = document.createElement('td');
            nameCell.textContent = rule.name;
            row.appendChild(nameCell);
            
            // Metric Name
            const metricCell = document.createElement('td');
            metricCell.textContent = rule.metric_name;
            row.appendChild(metricCell);
            
            // Condition
            const conditionCell = document.createElement('td');
            let conditionText = '';
            switch (rule.condition) {
                case 'gt': conditionText = 'Greater than'; break;
                case 'lt': conditionText = 'Less than'; break;
                case 'eq': conditionText = 'Equal to'; break;
                case 'ne': conditionText = 'Not equal to'; break;
                default: conditionText = rule.condition;
            }
            conditionCell.textContent = conditionText;
            row.appendChild(conditionCell);
            
            // Threshold
            const thresholdCell = document.createElement('td');
            thresholdCell.textContent = rule.threshold;
            row.appendChild(thresholdCell);
            
            // Severity
            const severityCell = document.createElement('td');
            let severityBadge = '';
            if (rule.severity === 'critical') {
                severityBadge = '<span class="badge bg-danger">Critical</span>';
            } else if (rule.severity === 'high') {
                severityBadge = '<span class="badge bg-warning text-dark">High</span>';
            } else if (rule.severity === 'medium') {
                severityBadge = '<span class="badge bg-info text-dark">Medium</span>';
            } else {
                severityBadge = '<span class="badge bg-secondary">Low</span>';
            }
            severityCell.innerHTML = severityBadge;
            row.appendChild(severityCell);
            
            // Status
            const statusCell = document.createElement('td');
            if (rule.enabled) {
                statusCell.innerHTML = '<span class="badge bg-success">Enabled</span>';
            } else {
                statusCell.innerHTML = '<span class="badge bg-secondary">Disabled</span>';
            }
            row.appendChild(statusCell);
            
            // Actions
            const actionsCell = document.createElement('td');
            
            // Edit Button
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-sm btn-primary me-1';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.title = 'Edit Rule';
            editBtn.setAttribute('data-bs-toggle', 'modal');
            editBtn.setAttribute('data-bs-target', '#ruleModal');
            editBtn.setAttribute('data-rule-id', rule.id);
            actionsCell.appendChild(editBtn);
            
            // Evaluate Button
            const evaluateBtn = document.createElement('button');
            evaluateBtn.className = 'btn btn-sm btn-info me-1';
            evaluateBtn.innerHTML = '<i class="fas fa-play"></i>';
            evaluateBtn.title = 'Evaluate Rule';
            evaluateBtn.addEventListener('click', () => evaluateRule(rule.id));
            actionsCell.appendChild(evaluateBtn);
            
            row.appendChild(actionsCell);
            
            tableBody.appendChild(row);
        });
    }
    
    // Reset rule form for adding new rule
    function resetRuleForm() {
        ruleIdInput.value = '';
        ruleForm.reset();
        ruleEnabledSwitch.checked = true;
        ruleCustomMetricContainer.style.display = 'none';
    }
    
    // Save rule (create or update)
    function saveRule() {
        // Validate form
        if (!ruleForm.checkValidity()) {
            ruleForm.reportValidity();
            return;
        }
        
        // Determine metric name (custom or selected)
        let metricName = ruleMetricSelect.value;
        if (metricName === 'custom') {
            metricName = ruleCustomMetricInput.value;
            if (!metricName) {
                ruleCustomMetricInput.focus();
                return;
            }
        }
        
        // Prepare data
        const ruleData = {
            name: ruleNameInput.value,
            description: ruleDescriptionInput.value,
            metric_name: metricName,
            condition: ruleConditionSelect.value,
            threshold: parseFloat(ruleThresholdInput.value),
            severity: ruleSeveritySelect.value,
            enabled: ruleEnabledSwitch.checked
        };
        
        const isUpdate = ruleIdInput.value !== '';
        const url = isUpdate 
            ? `/api/rules/${ruleIdInput.value}/`
            : '/api/rules/';
        const method = isUpdate ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(ruleData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Close modal and refresh rules
                const bsModal = bootstrap.Modal.getInstance(ruleModal);
                bsModal.hide();
                
                loadRules();
            })
            .catch(error => {
                console.error('Error saving rule:', error);
                alert('Failed to save rule. Please try again.');
            });
    }
    
    // Delete rule
    function deleteRule(ruleId) {
        fetch(`/api/rules/${ruleId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                loadRules();
            })
            .catch(error => {
                console.error('Error deleting rule:', error);
                alert('Failed to delete rule. Please try again.');
            });
    }
    
    // Evaluate rule against current metrics
    function evaluateRule(ruleId) {
        fetch(`/api/rules/${ruleId}/evaluate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.length > 0) {
                    alert(`Rule evaluated successfully. ${data.length} alert(s) created or updated.`);
                } else {
                    alert('Rule evaluated successfully. No alerts triggered.');
                }
            })
            .catch(error => {
                console.error('Error evaluating rule:', error);
                alert('Failed to evaluate rule. Please try again.');
            });
    }
    
    // Get CSRF token from cookies
    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %} 